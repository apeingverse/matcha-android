<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/5.0.15/signalr.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        display: flex;
        height: 100vh;
      }
      .sidebar {
        width: 30%;
        background-color: #f4f4f4;
        border-right: 1px solid #ddd;
        overflow-y: auto;
      }
      .chat-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .chat-item {
        display: flex;
        align-items: center;
        padding: 10px;
        border-bottom: 1px solid #ddd;
        cursor: pointer;
        position: relative;
      }
      .chat-item:hover {
        background-color: #e9e9e9;
      }
      .chat-item img {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        margin-right: 10px;
      }
      .chat-item .chat-info {
        flex-grow: 1;
      }
      .chat-item .chat-info .name {
        font-weight: bold;
        margin-bottom: 5px;
      }
      .chat-item .chat-info .last-message {
        color: #666;
        font-size: 0.9em;
      }
      .online-indicator {
        width: 10px;
        height: 10px;
        background-color: #28a745; /* Green color for online */
        border-radius: 50%;
        position: absolute;
        top: 10px;
        right: 10px;
        display: none; /* Hidden by default */
      }
      .chat-interface {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        padding: 20px;
      }
      .chat-messages {
        flex-grow: 1;
        overflow-y: auto;
        margin-bottom: 20px;
        display: flex;
        flex-direction: column;
        padding: 10px;
        gap: 10px;
      }
      .message {
        max-width: 70%;
        padding: 10px 15px;
        border-radius: 15px;
        word-wrap: break-word;
        font-size: 0.9em;
        line-height: 1.4;
        position: relative;
      }
      .message.sent {
        background-color: #dcf8c6;
        color: #000;
        align-self: flex-end;
        border-top-right-radius: 0;
      }
      .message.received {
        background-color: #fff;
        color: #000;
        align-self: flex-start;
        border-top-left-radius: 0;
        border: 1px solid #ddd;
      }
      .chat-input {
        display: flex;
        align-items: center;
        border-top: 1px solid #ddd;
        padding: 10px;
      }
      .chat-input input {
        flex-grow: 1;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 20px;
        margin-right: 10px;
        outline: none;
      }
      .chat-input button {
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
      }
      .chat-input button:hover {
        background-color: #0056b3;
      }
      .chat-input button img {
        width: 20px;
        height: 20px;
      }
      .typing {
        background-color: #f1f1f1;
        color: #000;
        align-self: flex-start;
        border-radius: 15px;
        padding: 10px 15px;
        max-width: 50%;
        display: flex;
        align-items: center;
      }

      .typing-dots {
        display: flex;
        gap: 5px;
      }

      .typing-dots span {
        width: 8px;
        height: 8px;
        background-color: #ccc;
        border-radius: 50%;
        animation: typing 1.5s infinite ease-in-out;
      }

      .typing-dots span:nth-child(1) {
        animation-delay: 0s;
      }

      .typing-dots span:nth-child(2) {
        animation-delay: 0.2s;
      }

      .typing-dots span:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes typing {
        0%,
        80%,
        100% {
          transform: scale(0);
        }
        40% {
          transform: scale(1);
        }
      }

      .message-actions {
        display: none;
        position: absolute;
        right: 5px;
        top: 5px;
      }

      .message:hover .message-actions {
        display: flex;
        gap: 5px;
      }

      .message-actions button {
        background: rgba(255, 255, 255, 0.8);
        border: none;
        border-radius: 3px;
        padding: 2px 5px;
        font-size: 0.8em;
        cursor: pointer;
      }

      .message-actions .edit-btn:hover {
        background-color: #f0f0f0;
      }

      .message-actions .delete-btn:hover {
        background-color: #ffcccc;
      }

      .attachment-button {
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        margin-right: 10px;
      }

      .attachment-button:hover {
        background-color: #0056b3;
      }

      .attachment-button img {
        width: 20px;
        height: 20px;
      }

      .attachment-menu {
        display: none;
        position: absolute;
        bottom: 70px;
        left: 20px;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        padding: 10px;
        z-index: 999; /* z-index'i artırın */
      }

      .attachment-menu.active {
        display: block !important; /* !important ekleyin */
      }

      .attachment-option {
        display: flex;
        align-items: center;
        padding: 8px 12px;
        cursor: pointer;
        border-radius: 4px;
      }

      .attachment-option:hover {
        background-color: #f0f0f0;
      }

      .attachment-option img {
        width: 24px;
        height: 24px;
        margin-right: 10px;
      }

      /* Dosya türlerine göre mesaj stilleri */
      .message-image {
        max-width: 200px;
        max-height: 200px;
        border-radius: 8px;
        cursor: pointer;
      }

      .message-video {
        max-width: 250px;
        border-radius: 8px;
      }

      .message-audio {
        width: 100%;
        max-width: 250px;
      }

      .message-file {
        display: flex;
        align-items: center;
        background-color: #f0f0f0;
        padding: 10px;
        border-radius: 8px;
        cursor: pointer;
      }

      .message-file img {
        width: 24px;
        height: 24px;
        margin-right: 10px;
      }

      .message-file span {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .message-footer {
        display: flex;
        justify-content: flex-end;
        font-size: 0.75em;
        margin-top: 4px;
        color: #888;
      }

      .message.sent .message-footer {
        text-align: right;
      }

      .message.received .message-footer {
        text-align: left;
      }

      .message-time {
        margin-right: 5px;
      }

      .edited-indicator {
        font-style: italic;
      }

      /* Okundu göstergeleri için CSS stillerini */
      .read-indicator {
        margin-left: 5px;
        font-size: 0.8em;
      }

      /* Varsayılan durum - tek gri tik */
      .message.sent .read-indicator {
        color: #bbb;
      }

      /* İletildi durumu - çift gri tik */
      .message.sent.delivered .read-indicator {
        color: #bbb;
      }

      /* Okundu durumu - çift mavi tik */
      .message.sent.read .read-indicator {
        color: #1136da !important; /* Yeşil/mavi tik (important ile öncelik veriyoruz) */
      }

      /* AI Yardım Düğmesi ve Menü Stilleri */
      .ai-help-button {
        background-color: #6b4226; /* Kahve rengi */
        color: white;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        margin-right: 10px;
      }

      .ai-help-button:hover {
        background-color: #8c5e35;
      }

      .ai-help-button img {
        width: 20px;
        height: 20px;
        filter: invert(1); /* İkonu beyaz yapar */
      }

      .ai-help-menu {
        display: none;
        position: absolute;
        bottom: 70px;
        left: 70px;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        padding: 10px;
        z-index: 999;
        width: 250px;
      }

      .ai-help-menu.active {
        display: block !important;
      }

      .ai-help-option {
        display: flex;
        align-items: center;
        padding: 10px;
        cursor: pointer;
        border-radius: 4px;
        margin-bottom: 5px;
        border: 1px solid #eee;
        transition: all 0.2s;
      }

      .ai-help-option:hover {
        background-color: #f5f5f5;
        border-color: #ddd;
      }

      .ai-help-option span {
        font-size: 0.9em;
        color: #333;
      }

      .ai-help-loading,
      .ai-help-error,
      .ai-help-empty {
        padding: 10px;
        text-align: center;
        color: #666;
        font-style: italic;
      }

      .message-actions .report-btn {
        background: rgba(255, 255, 255, 0.8);
        border: none;
        border-radius: 3px;
        padding: 2px 5px;
        font-size: 0.8em;
        cursor: pointer;
      }

      .message-actions .report-btn:hover {
        background-color: #ffcccc;
      }

      /* Make sure report buttons appear on received messages */
      .message.received:hover .message-actions {
        display: flex;
        gap: 5px;
      }
    </style>
  </head>
  <body>
    <div class="sidebar">
      <ul class="chat-list" id="chatList">
        <!-- Chat items will be dynamically added here -->
      </ul>
    </div>
    <div class="chat-interface">
      <div class="chat-messages" id="chatMessages">
        <div id="noChatsMessage" style="display: none">No chats available</div>
        <div
          id="noChatSelectedMessage"
          style="
            text-align: center;
            margin-top: 100px;
            color: #aaa;
            display: block;
          "
        >
          Please select a chat to start messaging
        </div>
      </div>
      <div class="chat-input" id="chatInputContainer" style="display: none">
        <button id="attachmentButton" class="attachment-button">
          <img
            src="https://cdn-icons-png.flaticon.com/512/3417/3417079.png"
            alt="Attach"
          />
        </button>
        <div id="attachmentMenu" class="attachment-menu">
          <div class="attachment-option" data-type="image">
            <img
              src="https://cdn-icons-png.flaticon.com/512/1829/1829548.png"
              alt="Image"
            />
            <span>Image</span>
          </div>
          <div class="attachment-option" data-type="video">
            <img
              src="https://cdn-icons-png.flaticon.com/512/3074/3074767.png"
              alt="Video"
            />
            <span>Video</span>
          </div>
          <div class="attachment-option" data-type="audio">
            <img
              src="https://cdn-icons-png.flaticon.com/512/2905/2905891.png"
              alt="Audio"
            />
            <span>Audio</span>
          </div>
          <div class="attachment-option" data-type="file">
            <img
              src="https://cdn-icons-png.flaticon.com/512/716/716784.png"
              alt="File"
            />
            <span>File</span>
          </div>
        </div>

        <!-- AI Yardım Düğmesi -->
        <button id="aiHelpButton" class="ai-help-button">
          <img
            src="https://cdn-icons-png.flaticon.com/512/1055/1055419.png"
            alt="Coffee Cup"
          />
        </button>
        <div id="aiHelpMenu" class="ai-help-menu">
          <!-- AI önerileri burada gösterilecek -->
        </div>

        <input
          type="text"
          id="messageInput"
          placeholder="Enter your message..."
        />
        <button id="sendButton">
          <img
            src="https://cdn-icons-png.flaticon.com/512/724/724954.png"
            alt="Send"
          />
        </button>
      </div>

      <!-- Gizli dosya input elemanları -->
      <input
        type="file"
        id="imageInput"
        accept="image/*"
        style="display: none"
      />
      <input
        type="file"
        id="videoInput"
        accept="video/*"
        style="display: none"
      />
      <input
        type="file"
        id="audioInput"
        accept="audio/*"
        style="display: none"
      />
      <input type="file" id="fileInput" accept="*/*" style="display: none" />
    </div>

    <script>
      const BASE_URL = "https://api.matchaapp.net";
      const HUB_URL = `${BASE_URL}/hub/ChatHub`;
      let accessToken = localStorage.getItem("accessToken");
      let senderProfiles = {}; // Store all profile IDs
      let receiverProfileId = null; // Set dynamically based on the selected chat
      let matchId = null; // Set dynamically based on the selected chat
      let matchModeType = null; // Set dynamically based on the selected chat
      let typingTimeout = null; // Timeout for delaying the StopTyping event

      // Redirecting if no token
      if (!accessToken) {
        console.error("Access token is missing. Redirecting to login page.");
        window.location.href = "/index.html";
      }

      // Create SignalR connection
      const connection = new signalR.HubConnectionBuilder()
        .withUrl(HUB_URL, {
          accessTokenFactory: () => accessToken,
          transport: signalR.HttpTransportType.LongPolling, // WebSocket hatalarını atlayarak doğrudan LongPolling kullan
        })
        .configureLogging(signalR.LogLevel.Information)
        .withAutomaticReconnect([0, 2000, 5000, 10000]) // Yeniden bağlanma stratejisi
        .build();

      // Axios interceptor for 401 errors
      axios.interceptors.response.use(
        (response) => response,
        (error) => {
          if (error.response && error.response.status === 401) {
            console.error("Unauthorized access - redirecting to login.");
            localStorage.removeItem("accessToken");
            window.location.href = "/index.html";
          }
          return Promise.reject(error);
        }
      );

      // -------------------- SignalR EVENT HANDLERS --------------------

      // Handle online matches
      connection.on("OnlineMatches", (onlineMatches) => {
        console.log("Currently online matches:", onlineMatches);
        onlineMatches.forEach((profileId) => {
          updateOnlineStatus(profileId, true);
        });
      });

      // Handle receiving messages
      connection.on("ReceiveMessage", (id, senderId, message) => {
        // Eğer chat açık değilse veya mesajın göndereni mevcut açık chat'in kullanıcısı değilse
        if (!receiverProfileId || senderId !== receiverProfileId) {
          // Gönderenin chat elementini bul ve bildirim ekle
          const chatItem = document.querySelector(
            `.chat-item[data-profile-id="${senderId}"]`
          );
          if (chatItem) {
            // Bildirim işaretleyicisi ekle
            const lastMessageElement = chatItem.querySelector(".last-message");
            if (lastMessageElement) {
              const timeString = formatMessageTime(new Date());
              lastMessageElement.innerHTML = `
                        <div class="last-message-content">
                            <span class="text">${
                              message.length > 20
                                ? message.substring(0, 17) + "..."
                                : message
                            }</span>
                            <span class="time">${timeString}</span>
                        </div>
                    `;
              lastMessageElement.style.fontWeight = "bold";
              lastMessageElement.style.color = "#007bff";
            }
          }
          return;
        }

        // Chat açıksa ve mesaj doğru kişiden geldiyse göster
        displayMessage({
          Id: id,
          SenderProfileId: senderId,
          Content: message,
          Type: 1, // Text message
          isSent: false,
        });

        // Son mesajı chat listesinde güncelle
        updateLastMessageInSidebar(senderId, message, 1, false, false, false);

        // Yeni gelen mesajı okundu olarak işaretle
        markMessagesAsRead();
      });

      // Handle message sent confirmation
      connection.on("MessageSent", (receiverProfileId, messageId) => {
        const chatMessages = document.getElementById("chatMessages");
        const lastMessage = chatMessages.lastElementChild;

        if (lastMessage && lastMessage.classList.contains("sent")) {
          // Assign the messageId to the last message
          lastMessage.dataset.messageId = messageId;
          lastMessage.classList.add("delivered");

          // Update the read indicator to show "delivered" (double gray tick)
          const footer = lastMessage.querySelector(".message-footer");
          if (footer) {
            const readIndicator = footer.querySelector(".read-indicator");
            if (readIndicator) {
              readIndicator.textContent = "✓✓"; // Double tick
            }
          }

          // Enable the edit and delete buttons
          const editBtn = lastMessage.querySelector(".edit-btn");
          const deleteBtn = lastMessage.querySelector(".delete-btn");

          if (editBtn) {
            editBtn.disabled = false; // Enable the edit button
            editBtn.addEventListener("click", () => {
              editMessage(messageId); // Attach the editMessage function
            });
          }

          if (deleteBtn) {
            deleteBtn.disabled = false; // Enable the delete button
            deleteBtn.addEventListener("click", () => {
              deleteMessage(messageId); // Attach the deleteMessage function
            });
          }
        }
      });

      // Handle user online status
      connection.on("UserOnline", (profileId) => {
        updateOnlineStatus(profileId, true);
      });

      // Handle user offline status
      connection.on("UserOffline", (profileId) => {
        console.log(`User with profile ID ${profileId} went offline`);
        updateOnlineStatus(profileId, false);

        if (receiverProfileId === profileId) {
          showOfflineNotification();
        }
      });

      // Handle typing indicators
      connection.on("TypingStarted", (senderProfileId) => {
        if (receiverProfileId === senderProfileId) {
          showTypingIndicator();
        }
      });

      connection.on("TypingStopped", (senderProfileId) => {
        if (receiverProfileId === senderProfileId) {
          hideTypingIndicator();
        }
      });

      // Handle message editing
      connection.on("MessageEdited", (messageId, newContent) => {
        console.log("Message edited:", messageId, newContent);
        updateMessageContent(messageId, newContent, true);
      });

      connection.on("MessageEditConfirmed", (messageId, newContent) => {
        console.log("Message edit confirmed:", messageId, newContent);
        updateMessageContent(messageId, newContent, true);
      });

      // Handle message deletion
      connection.on("MessageDeleted", (messageId) => {
        markMessageAsDeleted(messageId);

        // Mesaj silindi son mesajı güncelle
        if (receiverProfileId) {
          updateLastMessageInSidebar(receiverProfileId, "", 1, true);
        }
      });

      connection.on("MessageDeleteConfirmed", (messageId) => {
        markMessageAsDeleted(messageId);

        // Mesaj silindi son mesajı güncelle
        if (receiverProfileId) {
          updateLastMessageInSidebar(receiverProfileId, "", 1, true);
        }
      });

      // Handle file attachments
      connection.on("ReceiveFile", (messageId, senderId, fileUrl, fileType) => {
        if (!receiverProfileId || senderId !== receiverProfileId) {
          const chatItem = document.querySelector(
            `.chat-item[data-profile-id="${senderId}"]`
          );
          if (chatItem) {
            const lastMessageElement = chatItem.querySelector(".last-message");
            if (lastMessageElement) {
              const attachmentType =
                fileType === "image"
                  ? "📷 Image"
                  : fileType === "video"
                  ? "🎬 Video"
                  : fileType === "audio"
                  ? "🎵 Audio"
                  : "📎 File";
              const timeString = formatMessageTime(new Date());
              lastMessageElement.innerHTML = `
                        <div class="last-message-content">
                            <span class="text">${attachmentType}</span>
                            <span class="time">${timeString}</span>
                        </div>
                    `;
              lastMessageElement.style.fontWeight = "bold";
              lastMessageElement.style.color = "#007bff";
            }
          }
          return;
        }

        const messageType =
          fileType === "image"
            ? 2
            : fileType === "video"
            ? 3
            : fileType === "audio"
            ? 4
            : 5;

        // Chat açıksa ve mesaj doğru kişiden geldiyse göster
        displayMessage({
          Id: messageId,
          SenderProfileId: senderId,
          Content: fileUrl,
          Type: messageType,
          isSent: false,
        });

        // Son mesajı chat listesinde güncelle
        updateLastMessageInSidebar(senderId, fileUrl, messageType);

        // Yeni gelen dosya mesajını okundu olarak işaretle
        markMessagesAsRead();
      });

      connection.on(
        "FileUploadConfirmed",
        (messageId, receiverId, fileUrl, fileType) => {
          console.log(
            "File upload confirmed:",
            messageId,
            receiverId,
            fileUrl,
            fileType
          );

          // Find if there's already a temporary message for this upload
          const allSentMessages = document.querySelectorAll(".message.sent");
          const lastMessage = Array.from(allSentMessages)
            .reverse()
            .find(
              (msg) =>
                !msg.dataset.messageId || msg.dataset.messageId.startsWith("temp-")
            );

          // Determine the message type based on file type
          const messageType =
            fileType === "image"
              ? 2
              : fileType === "video"
              ? 3
              : fileType === "audio"
              ? 4
              : 5;

          if (lastMessage && lastMessage.textContent.includes("Uploading")) {
            // Remove the "Uploading..." message if it exists
            lastMessage.remove();
          }

          // Display the actual file in the chat
          const messageElement = displayMessage({
            Id: messageId,
            Content: fileUrl,
            Type: messageType,
            isSent: true,
          });

          // Update the UI for the new message
          messageElement.classList.add("delivered");

          // Update the read indicator to show "delivered" (double gray tick)
          const footer = messageElement.querySelector(".message-footer");
          if (footer) {
            const readIndicator = footer.querySelector(".read-indicator");
            if (readIndicator) {
              readIndicator.textContent = "✓✓"; // Double tick
              readIndicator.style.color = "#bbb"; // Gray color for attachments
            }
          }

          // Update last message in sidebar
          updateLastMessageInSidebar(
            receiverId,
            fileUrl,
            messageType,
            false, // not deleted
            true, // from self
            false // not read yet
          );

          // // Make sure the delete button is enabled and edit is disabled for attachments
          // const messageActions = messageElement.querySelector(".message-actions");
          // if (messageActions) {
          //   const deleteBtn = messageActions.querySelector(".delete-btn");
          //   const editBtn = messageActions.querySelector(".edit-btn");

          //   if (deleteBtn) {
          //     deleteBtn.disabled = false;
          //     deleteBtn.addEventListener("click", () => {
          //       deleteMessage(messageId);
          //     });
          //   }

          //   if (editBtn) {
          //     editBtn.disabled = true; // Attachments can't be edited
          //   }
          // }
        }
      );

      // Okundu göstergeleri için SignalR event handler'larını ekleyin
      connection.on("MessagesRead", (receiverProfileId, messageIds) => {
        console.log(`User ${receiverProfileId} read messages:`, messageIds);

        // Mesajları okundu olarak işaretle
        messageIds.forEach((id) => {
          const messageElement = document.querySelector(
            `[data-message-id="${id}"]`
          );
          if (messageElement && messageElement.classList.contains("sent")) {
            // Okundu olarak işaretle
            messageElement.classList.add("read");

            // Okundu göstergesini güncelle - çift mavi tik
            const footer = messageElement.querySelector(".message-footer");
            if (footer) {
              const readIndicator = footer.querySelector(".read-indicator");
              if (readIndicator) {
                readIndicator.textContent = "✓✓"; // Çift tik
                readIndicator.classList.add("read-indicator-blue"); // CSS sınıfı ekle
                readIndicator.style.color = "#1136da"; // Doğrudan stil uygula
              }
            }
          }
        });
      });

      connection.on("MessagesReadConfirmed", (senderProfileId, messageIds) => {
        console.log("Messages marked as read:", messageIds);

        // Burayı boş bırakmayın - mesajları okundu olarak işaretleyin
        messageIds.forEach((id) => {
          const messageElement = document.querySelector(
            `[data-message-id="${id}"]`
          );
          if (messageElement && messageElement.classList.contains("sent")) {
            // Okundu olarak işaretle
            messageElement.classList.add("read");

            // Okundu göstergesini güncelle - çift mavi tik
            const footer = messageElement.querySelector(".message-footer");
            if (footer) {
              const readIndicator = footer.querySelector(".read-indicator");
              if (readIndicator) {
                readIndicator.textContent = "✓✓"; // Çift tik
                readIndicator.style.color = "#1136da"; // Yeşil/mavi renk
              }
            }
          }
        });
      });

      // AI Öneri Sistemini Başlat
      function initializeAIHelpSystem() {
        console.log("Initializing AI help system...");

        const aiHelpButton = document.getElementById("aiHelpButton");
        const aiHelpMenu = document.getElementById("aiHelpMenu");

        if (!aiHelpButton || !aiHelpMenu) {
          console.error("AI help elements not found!");
          return;
        }

        // AI yardım menüsünü aç/kapat
        aiHelpButton.addEventListener("click", (e) => {
          console.log("AI help button clicked!");
          e.stopPropagation();

          // Menü kapalıysa ve açılacaksa önerileri getir
          if (!aiHelpMenu.classList.contains("active")) {
            fetchAIChatHelp();
          }

          aiHelpMenu.classList.toggle("active");
        });

        // Dışarı tıklandığında menüyü kapat
        document.addEventListener("click", (e) => {
          if (
            !e.target.closest("#aiHelpButton") &&
            !e.target.closest("#aiHelpMenu")
          ) {
            aiHelpMenu.classList.remove("active");
          }
        });

        console.log("AI help system initialized successfully!");
      }

      // AI önerilerini getir
      async function fetchAIChatHelp() {
        if (!matchId) {
          console.error("No match selected");
          aiHelpMenu.innerHTML =
            '<div class="ai-help-empty">Please select a chat first</div>';
          return;
        }

        try {
          // Yükleme durumunu göster
          aiHelpMenu.innerHTML =
            '<div class="ai-help-loading">Loading suggestions...</div>';

          const response = await axios.get(
            `${BASE_URL}/api/Chat/GetAIChatHelp`,
            {
              headers: { Authorization: `Bearer ${accessToken}` },
              params: { matchId: matchId },
            }
          );

          console.log("AI suggestions received:", response.data);

          if (response.data && response.data.response) {
            const suggestions = response.data.response;

            // Menüyü temizle
            aiHelpMenu.innerHTML = "";

            // Her öneriyi menüye ekle
            if (suggestions.response1) {
              addAIChatHelpOption(suggestions.response1);
            }
            if (suggestions.response2) {
              addAIChatHelpOption(suggestions.response2);
            }
            if (suggestions.response3) {
              addAIChatHelpOption(suggestions.response3);
            }

            // Öneri yoksa mesaj göster
            if (
              !suggestions.response1 &&
              !suggestions.response2 &&
              !suggestions.response3
            ) {
              aiHelpMenu.innerHTML =
                '<div class="ai-help-empty">No suggestions available</div>';
            }
          } else {
            aiHelpMenu.innerHTML =
              '<div class="ai-help-error">Invalid response format</div>';
          }
        } catch (error) {
          console.error("Error fetching AI chat help:", error);
          aiHelpMenu.innerHTML =
            '<div class="ai-help-error">Failed to load suggestions</div>';
        }
      }

      // Öneri seçeneği ekle
      function addAIChatHelpOption(text) {
        const option = document.createElement("div");
        option.className = "ai-help-option";
        option.innerHTML = `<span>${text}</span>`;

        // Tıklandığında mesaj giriş alanına metni yerleştir
        option.addEventListener("click", () => {
          const messageInput = document.getElementById("messageInput");
          messageInput.value = text;
          messageInput.focus();

          // Menüyü kapat
          aiHelpMenu.classList.remove("active");
        });

        aiHelpMenu.appendChild(option);
      }

      // -------------------- UTILITY FUNCTIONS --------------------

      function updateOnlineStatus(profileId, isOnline) {
        const chatItem = document.querySelector(
          `.chat-item[data-profile-id="${profileId}"]`
        );
        if (chatItem) {
          const onlineIndicator = chatItem.querySelector(".online-indicator");
          if (onlineIndicator) {
            onlineIndicator.style.display = isOnline ? "block" : "none";
          }
        }
      }

      function showOfflineNotification() {
        const chatMessages = document.getElementById("chatMessages");
        const disconnectNotification = document.createElement("div");
        disconnectNotification.textContent = "User has gone offline";
        disconnectNotification.style.textAlign = "center";
        disconnectNotification.style.color = "#999";
        disconnectNotification.style.padding = "10px";
        disconnectNotification.style.margin = "10px 0";
        chatMessages.appendChild(disconnectNotification);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function showTypingIndicator() {
        const chatMessages = document.getElementById("chatMessages");
        // Önce mevcut göstergeyi kaldır
        hideTypingIndicator();

        // Yeni göstergeyi oluştur ve en sona ekle
        const typingIndicator = document.createElement("div");
        typingIndicator.id = "typingIndicator";
        typingIndicator.className = "message typing";
        typingIndicator.innerHTML = `
            <div class="typing-dots">
                <span></span><span></span><span></span>
            </div>
        `;
        chatMessages.appendChild(typingIndicator);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function hideTypingIndicator() {
        const typingIndicator = document.getElementById("typingIndicator");
        if (typingIndicator) {
          typingIndicator.remove();
        }
      }

      function updateMessageContent(messageId, newContent, isEdited) {
        console.log(
          "Updating message content:",
          messageId,
          newContent,
          isEdited
        );

        const message = document.querySelector(
          `[data-message-id="${messageId}"]`
        );
        if (message) {
          // İçerik değiştirme
          const contentSpan = message.querySelector(
            "span:not(.message-time):not(.edited-indicator)"
          );
          if (contentSpan) {
            contentSpan.textContent = newContent;

            // Düzenleme göstergesi ekleme
            if (isEdited) {
              const footer = message.querySelector(".message-footer");
              if (footer) {
                // Mevcut düzenleme göstergesini kontrol et
                let editedIndicator = footer.querySelector(".edited-indicator");

                // Yoksa oluştur
                if (!editedIndicator) {
                  editedIndicator = document.createElement("span");
                  editedIndicator.className = "edited-indicator";
                  editedIndicator.textContent = "(edited)";
                  footer.appendChild(editedIndicator);
                }
              }
            }
          }
        }
      }

      function markMessageAsDeleted(messageId) {
        const message = document.querySelector(
          `[data-message-id="${messageId}"]`
        );
        if (message) {
          message.innerHTML = "<em>This message has been deleted</em>";
          message.style.fontStyle = "italic";
          message.style.color = "#999";
        }
      }

      // -------------------- MESSAGE DISPLAY & ACTIONS --------------------

      function displayMessage(message) {
    const chatMessages = document.getElementById("chatMessages");
    const noChatsMessage = document.getElementById("noChatsMessage");
    if (noChatsMessage) noChatsMessage.style.display = "none";

    const messageElement = document.createElement("div");
    messageElement.className = `message ${message.isSent ? "sent" : "received"}`;

    // Add message ID as data attribute
    if (message.Id) {
        messageElement.dataset.messageId = message.Id;
    }

    // Determine if this is an attachment and what type
    let isAttachment = false;
    let attachmentType = "";

    if (message.Type) {
        // Use the Type value from API
        attachmentType =
            message.Type === 1
                ? "text"
                : message.Type === 2
                ? "image"
                : message.Type === 3
                ? "video"
                : message.Type === 4
                ? "audio"
                : "file";

        isAttachment = attachmentType !== "text";
    } else if (message.Content && message.Content.startsWith("http")) {
        // Try to determine type from URL
        if (message.Content.match(/\.(jpeg|jpg|gif|png)$/i)) {
            attachmentType = "image";
            isAttachment = true;
        } else if (message.Content.match(/\.(mp4|mov|avi|wmv)$/i)) {
            attachmentType = "video";
            isAttachment = true;
        } else if (message.Content.match(/\.(mp3|wav|ogg)$/i)) {
            attachmentType = "audio";
            isAttachment = true;
        } else if (message.Content.match(/\.(pdf|doc|docx|xls|xlsx|txt)$/i)) {
            attachmentType = "file";
            isAttachment = true;
        }
    }

    // Generate content based on message type
    let content = "";

    // Silinen mesaj kontrolü ekle
    if (message.isDeleted) {
        content = `<em>This message has been deleted</em>`;
        messageElement.style.fontStyle = "italic";
        messageElement.style.color = "#999";

        // Silinen mesajlar için düzenleme/silme butonlarını gösterme
        if (message.isSent) {
            messageElement.innerHTML = content;
        } else {
            messageElement.innerHTML = content;
        }

        chatMessages.appendChild(messageElement);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        return messageElement;
    }

    if (isAttachment) {
        switch (attachmentType) {
            case "image":
                content = `<img src="${message.Content}" alt="Image" class="message-image" onclick="window.open('${message.Content}', '_blank')">`;
                break;
            case "video":
                content = `<video controls class="message-video">
                                <source src="${message.Content}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>`;
                break;
            case "audio":
                content = `<audio controls class="message-audio">
                                <source src="${message.Content}" type="audio/mpeg">
                                Your browser does not support the audio element.
                            </audio>`;
                break;
            case "file":
                // Extract filename from URL
                const fileName = message.Content.split("/").pop();
                content = `<div class="message-file" onclick="window.open('${message.Content}', '_blank')">
                                <img src="https://cdn-icons-png.flaticon.com/512/716/716784.png" alt="File">
                                <span>${fileName || "Download File"}</span>
                            </div>`;
                break;
        }
    } else {
        // Text message
        content = `<span>${message.Content}</span>`;
    }

    // Mesaj alt bilgisi oluştur (zaman damgası, okundu göstergesi ve düzenleme bilgisi)
    const timeString = formatMessageTime(message.createdDate || new Date());
    const isEdited = Boolean(message.isEdited);
    const editedString = isEdited ? '<span class="edited-indicator">(edited)</span>' : "";

    // Mesaj durum göstergesi - sadece gönderilmiş mesajlar için
    let readIndicator = "";
    if (message.isSent) {
        if (message.isRead) {
            // Message is read - show double green checkmark
            readIndicator = '<span class="read-indicator read-indicator-blue" style="color: #1136da !important;">✓✓</span>';
            messageElement.classList.add("read");
        } else {
            // Message is sent but not read yet - show double gray tick
            readIndicator = '<span class="read-indicator">✓✓</span>';
        }
    }

    // Create footerHtml here, before using it
    const footerHtml = `
        <div class="message-footer">
            <span class="message-time">${timeString}</span>
            ${readIndicator}
            ${editedString}
        </div>
    `;

    // Add action buttons for sent messages
    if (message.isSent) {
        const isAttachment = message.Type && message.Type !== 1; // Check if it's an attachment (Type !== 1 means not text)

        messageElement.innerHTML = `
            ${content}
            ${footerHtml}
            <div class="message-actions">
                <button class="edit-btn" ${isAttachment ? "disabled" : ""} ${message.Id ? "" : "disabled"}>Edit</button>
                <button class="delete-btn" ${message.Id ? "" : "disabled"}>Delete</button>
            </div>
        `;

        // Add event listeners
        const editBtn = messageElement.querySelector(".edit-btn");
        const deleteBtn = messageElement.querySelector(".delete-btn");

        if (editBtn && !isAttachment && message.Id) {
            editBtn.addEventListener("click", () => {
                editMessage(message.Id);
            });
        }

        if (deleteBtn && message.Id) {
            deleteBtn.addEventListener("click", () => {
                deleteMessage(message.Id);
            });
        }
    } else {
        // This is a received message - add report button
        messageElement.innerHTML = `
            ${content}
            ${footerHtml}
            <div class="message-actions">
                <button class="report-btn" ${message.Id ? "" : "disabled"}>Report</button>
            </div>
        `;

        // Add event listener for report button
        const reportBtn = messageElement.querySelector(".report-btn");
        if (reportBtn && message.Id) {
            reportBtn.addEventListener("click", () => {
                reportMessage(message.Id);
            });
        }
    }

    chatMessages.appendChild(messageElement);

    // Eğer typing indicator aktifse, mesajın altına taşı
    const typingIndicator = document.getElementById("typingIndicator");
    if (typingIndicator) {
        // Göstergeyi kaldır ve yeniden ekle (en sona taşımak için)
        chatMessages.removeChild(typingIndicator);
        chatMessages.appendChild(typingIndicator);
    }

    // Sohbet penceresini en alta kaydır
    chatMessages.scrollTop = chatMessages.scrollHeight;

    return messageElement;
}

      function editMessage(messageId) {
        const message = document.querySelector(
          `[data-message-id="${messageId}"]`
        );
        if (!message) return;

        const isAttachment = message.querySelector(
          ".message-image, .message-video, .message-audio, .message-file"
        );
        if (isAttachment) {
          alert("Attachments cannot be edited.");
          return;
        }

        const currentContent = message.querySelector("span").textContent;
        const newContent = prompt("Edit your message:", currentContent);

        if (newContent && newContent !== currentContent) {
          try {
            const senderProfileId = senderProfiles[matchModeType];
            connection.invoke(
              "EditTextMessage",
              senderProfileId,
              receiverProfileId,
              messageId,
              newContent
            );
          } catch (error) {
            console.error("Failed to edit message:", error);
          }
        }
      }

      function deleteMessage(messageId) {
        if (confirm("Are you sure you want to delete this message?")) {
          try {
            const senderProfileId = senderProfiles[matchModeType];
            connection.invoke(
              "DeleteMessage",
              senderProfileId,
              receiverProfileId,
              messageId
            );
          } catch (error) {
            console.error("Failed to delete message:", error);
          }
        }
      }

      function reportMessage(messageId) {
        // Prompt for reason
        const reason = prompt(
          "Please enter the reason for reporting this message:",
          ""
        );

        // If user cancels or enters empty reason, abort
        if (!reason) return;

        try {
          // Call API to report message
          axios
            .post(`${BASE_URL}/api/Safety/ReportMessage`, null, {
              headers: { Authorization: `Bearer ${accessToken}` },
              params: {
                reportedMessageId: messageId,
                reason: reason,
              },
            })
            .then((response) => {
              if (response.data && response.data.response === true) {
                alert("Message reported successfully.");
              } else {
                alert("Failed to report message.");
              }
            })
            .catch((error) => {
              console.error("Error reporting message:", error);
              alert("Failed to report message. Please try again later.");
            });
        } catch (error) {
          console.error("Failed to report message:", error);
          alert("An error occurred while reporting the message.");
        }
      }

      // Zaman damgasını formatlamak için yardımcı fonksiyon
      function formatMessageTime(dateObj) {
        if (!dateObj) return "";

        // Eğer string olarak geldiyse, Date nesnesine çevir
        if (typeof dateObj === "string") {
          dateObj = new Date(dateObj);
        }

        // Geçerli bir tarih değilse boş döndür
        if (isNaN(dateObj.getTime())) return "";

        const now = new Date();
        const today = new Date(
          now.getFullYear(),
          now.getMonth(),
          now.getDate()
        );
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);

        // Aynı gün içindeyse sadece saat:dakika
        if (dateObj >= today) {
          return dateObj.toLocaleTimeString([], {
            hour: "2-digit",
            minute: "2-digit",
          });
        }
        // Dün ise "Dün" ve saat
        else if (dateObj >= yesterday) {
          return (
            "Yesterday, " +
            dateObj.toLocaleTimeString([], {
              hour: "2-digit",
              minute: "2-digit",
            })
          );
        }
        // Diğer günlerse tarih ve saat
        else {
          return (
            dateObj.toLocaleDateString([], {
              day: "2-digit",
              month: "2-digit",
              year: "numeric",
            }) +
            ", " +
            dateObj.toLocaleTimeString([], {
              hour: "2-digit",
              minute: "2-digit",
            })
          );
        }
      }

      // -------------------- API FUNCTIONS --------------------

      async function startConnection() {
        try {
          if (connection.state !== signalR.HubConnectionState.Disconnected) {
            console.log(
              "SignalR connection is already in state:",
              connection.state
            );
            return;
          }

          await connection.start();
          console.log("SignalR connected.");
        } catch (error) {
          console.error("SignalR connection failed:", error);
          setTimeout(startConnection, 5000);
        }
      }

      async function fetchChats() {
        try {
          const response = await axios.get(
            `${BASE_URL}/api/Match/GetMatchesForChat`,
            {
              headers: { Authorization: `Bearer ${accessToken}` },
            }
          );

          const chatList = document.getElementById("chatList");
          chatList.innerHTML = "";

          const profiles = response.data.response;
          if (!profiles || profiles.length === 0) {
            document.getElementById("chatInputContainer").style.display =
              "none";
            document.getElementById("noChatSelectedMessage").style.display =
              "block";
            document.getElementById("noChatsMessage").style.display = "block";
            return;
          }

          profiles.forEach((profile) => {
            const chatItem = document.createElement("li");
            chatItem.className = "chat-item";
            chatItem.dataset.profileId = profile.profileId;
            chatItem.dataset.matchId = profile.matchId;

            // Son mesaj bilgisini hazırla
            let lastMessageHtml = "<span>No messages yet</span>";

            if (profile.lastMessage) {
              const lastMsg = profile.lastMessage;
              let messageText = "";

              // Mesaj öneki belirleme (kendinden geldiyse "You: " ekle)
              const isOwnMessage =
                lastMsg.senderProfileId ===
                senderProfiles[profile.matchModeType];
              const messagePrefix = isOwnMessage ? "You: " : "";

              // Mesaj içeriğini mesaj türüne göre belirle
              if (lastMsg.isDeleted) {
                messageText = "This message was deleted";
              } else if (lastMsg.type === 1) {
                // Text message
                messageText =
                  lastMsg.content.length > 20
                    ? lastMsg.content.substring(0, 17) + "..."
                    : lastMsg.content;
              } else if (lastMsg.type === 2) {
                messageText = "📷 Image";
              } else if (lastMsg.type === 3) {
                messageText = "🎬 Video";
              } else if (lastMsg.type === 4) {
                messageText = "🎵 Audio";
              } else if (lastMsg.type === 5) {
                messageText = "📎 File";
              }

              // Zaman damgasını formatla
              const timeString = formatMessageTime(new Date(lastMsg.timeStamp));

              // Okunmamış mesajlar için stil
              const isUnread = !lastMsg.isRead && !isOwnMessage;
              const messageStyle = isUnread
                ? 'style="color: #007bff; font-weight: bold;"'
                : "";

              // Son mesaj HTML'ini güncelle
              lastMessageHtml = `
                        <div class="last-message-content">
                            <span class="text" ${messageStyle}>${messagePrefix}${messageText}</span>
                            <span class="time">${timeString}</span>
                        </div>
                    `;
            }

            chatItem.innerHTML = `
                    <img src="${
                      profile.profilePicture || "https://via.placeholder.com/50"
                    }" alt="Profile Picture">
                    <div class="chat-info">
                        <div class="name">${profile.fullName}</div>
                        <div class="last-message">${lastMessageHtml}</div>
                    </div>
                    <div class="online-indicator" style="display: none;"></div>
                `;

            // Click event (mevcut kod aynı kalır)
            chatItem.addEventListener("click", () => {
              // Tüm öğelerdeki seçim vurgusunu kaldır
              document.querySelectorAll(".chat-item").forEach((item) => {
                item.classList.remove("selected");
              });

              // Tıklanan öğeye seçim vurgusu ekle
              chatItem.classList.add("selected");

              // Bildirim stilini sıfırla
              const lastMessageElement =
                chatItem.querySelector(".last-message");
              if (lastMessageElement) {
                lastMessageElement.style.fontWeight = "normal";
                lastMessageElement.style.color = "#666";
              }

              receiverProfileId = profile.profileId;
              matchId = profile.matchId;
              matchModeType = profile.matchModeType;
              openChat(matchId);
            });

            chatList.appendChild(chatItem);
          });

          // Son mesaj gösterimi için CSS stil ekle
          const style = document.createElement("style");
          style.textContent = `
                .last-message-content {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    width: 100%;
                }
                .last-message-content .text {
                    white-space: nowrap;
                    overflow: hidden;
                    text-overflow: ellipsis;
                    flex-grow: 1;
                }
                .last-message-content .time {
                    font-size: 0.8em;
                    color: #999;
                    margin-left: 5px;
                    white-space: nowrap;
                }
            `;
          document.head.appendChild(style);
        } catch (error) {
          console.error("Failed to fetch chats:", error);
        }
      }

      async function openChat(matchId) {
        try {
          const response = await axios.get(
            `${BASE_URL}/api/Chat/GetChatMessages`,
            {
              headers: { Authorization: `Bearer ${accessToken}` },
              params: { matchId: matchId },
            }
          );

          const messages = response.data.response;
          const chatMessages = document.getElementById("chatMessages");
          chatMessages.innerHTML = "";

          if (!messages || messages.length === 0) {
            const noMessages = document.createElement("div");
            noMessages.textContent = "No messages found.";
            noMessages.style.textAlign = "center";
            noMessages.style.color = "#aaa";
            chatMessages.appendChild(noMessages);

            // Chat input barını göster
            document.getElementById("chatInputContainer").style.display =
              "flex";
            document.getElementById("noChatSelectedMessage").style.display =
              "none";
            // noChatsMessage null kontrolü ekleyin
            const noChatsMessage = document.getElementById("noChatsMessage");
            if (noChatsMessage) noChatsMessage.style.display = "none";

            return;
          }

          messages.forEach((message) => {
            console.log("Message data:", {
              id: message.id,
              edited: message.isModified, // isEdited yerine isModified kullan
              type: typeof message.isModified,
              value: String(message.isModified),
            });

            // isEdited değerini daha güvenilir bir şekilde değerlendirin
            let isEditedValue = false;

            // Farklı olası veri türlerini kontrol edin (isModified kullanarak)
            if (
              message.isModified === true ||
              message.isModified === 1 ||
              message.isModified === "true" ||
              message.isModified === "1"
            ) {
              isEditedValue = true;
            }

            if (
              message.isRead &&
              message.senderProfileId === senderProfiles[matchModeType]
            ) {
              const messageElement = document.querySelector(
                `[data-message-id="${message.id}"]`
              );
              if (messageElement) {
                messageElement.classList.add("read");
                const readIndicator =
                  messageElement.querySelector(".read-indicator");
                if (readIndicator) {
                  readIndicator.textContent = "✓✓";
                  readIndicator.style.color = "#1136da";
                  readIndicator.classList.add("read-indicator-blue");
                }
              }
            }

            // Text = 1, Image = 2, Video = 3, Audio = 4, File = 5
            displayMessage({
              Id: message.id,
              SenderProfileId: message.senderProfileId,
              Content: message.content,
              Type: message.messageType,
              isEdited: isEditedValue, // isModified değerinden alıyoruz
              isDeleted: Boolean(message.isDeleted),
              createdDate: message.timeStamp, // "createdDate" yerine "timeStamp" kullan
              isSent: message.senderProfileId === senderProfiles[matchModeType],
              isRead: message.isRead, // Add this line
            });
          });

          chatMessages.scrollTop = chatMessages.scrollHeight;

          // Chat input barını göster
          document.getElementById("chatInputContainer").style.display = "flex";
          document.getElementById("noChatSelectedMessage").style.display =
            "none";
          // noChatsMessage null kontrolü
          const noChatsMessage = document.getElementById("noChatsMessage");
          if (noChatsMessage) noChatsMessage.style.display = "none";

          // Mesajları okundu olarak işaretle
          markMessagesAsRead();
        } catch (error) {
          if (error.response && error.response.status === 404) {
            // Handle 404 error (no messages found)
            const chatMessages = document.getElementById("chatMessages");
            chatMessages.innerHTML = "";

            const noMessages = document.createElement("div");
            noMessages.textContent =
              "No messages found. Start the conversation!";
            noMessages.style.textAlign = "center";
            noMessages.style.color = "#aaa";
            chatMessages.appendChild(noMessages);

            // Show the chat input bar
            document.getElementById("chatInputContainer").style.display =
              "flex";
            document.getElementById("noChatSelectedMessage").style.display =
              "none";
            const noChatsMessage = document.getElementById("noChatsMessage");
            if (noChatsMessage) noChatsMessage.style.display = "none";
          } else {
            console.error("Failed to fetch chat messages:", error);
          }
        }
      }

      async function getLoggedInUserProfileState() {
        try {
          const response = await axios.get(
            `${BASE_URL}/api/Profile/GetLoggedInUserProfileState`,
            {
              headers: { Authorization: `Bearer ${accessToken}` },
            }
          );

          const profileState = response.data.response;
          console.log("Profile state:", profileState);

          // Save profile IDs
          if (profileState.isDatingProfileCreated)
            senderProfiles[1] = profileState.datingProfileId;
          if (profileState.isCasualProfileCreated)
            senderProfiles[2] = profileState.casualProfileId;
          if (profileState.isSportsProfileCreated)
            senderProfiles[3] = profileState.sportsProfileId;
          if (profileState.isBusinessProfileCreated)
            senderProfiles[4] = profileState.businessProfileId;
          if (profileState.isStudyProfileCreated)
            senderProfiles[5] = profileState.studyProfileId;

          return profileState;
        } catch (error) {
          console.error("Failed to fetch profile state:", error);
          throw error;
        }
      }

      // -------------------- ATTACHMENT SYSTEM --------------------

      function initializeAttachmentSystem() {
        console.log("Initializing attachment system...");

        const attachmentButton = document.getElementById("attachmentButton");
        const attachmentMenu = document.getElementById("attachmentMenu");

        if (!attachmentButton || !attachmentMenu) {
          console.error("Attachment elements not found!");
          return;
        }

        // Toggle attachment menu
        attachmentButton.addEventListener("click", (e) => {
          console.log("Attachment button clicked!");
          e.stopPropagation();
          attachmentMenu.classList.toggle("active");
        });

        // Handle attachment type selection
        document.querySelectorAll(".attachment-option").forEach((option) => {
          option.addEventListener("click", (e) => {
            e.stopPropagation();
            const fileType = option.getAttribute("data-type");
            console.log(`Selected file type: ${fileType}`);
            const fileInput = document.getElementById(`${fileType}Input`);

            if (fileInput) {
              fileInput.click();
            } else {
              console.error(`File input for type ${fileType} not found!`);
            }

            attachmentMenu.classList.remove("active");
          });
        });

        // Hide menu when clicking outside
        document.addEventListener("click", (e) => {
          if (
            !e.target.closest("#attachmentButton") &&
            !e.target.closest("#attachmentMenu")
          ) {
            attachmentMenu.classList.remove("active");
          }
        });

        // Handle file uploads
        ["image", "video", "audio", "file"].forEach((fileType) => {
          const fileInput = document.getElementById(`${fileType}Input`);

          if (!fileInput) {
            console.error(`File input element for type ${fileType} not found!`);
            return;
          }

          fileInput.addEventListener("change", async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            try {
              // Prepare FormData
              const formData = new FormData();

              // Endpoint'i doğru şekilde tanımla
              const endpoint =
                fileType === "image"
                  ? "SendPhotoAttachment"
                  : fileType === "video"
                  ? "SendVideoAttachment"
                  : fileType === "audio"
                  ? "SendAudioAttachment"
                  : "SendFileAttachment";

              // Endpoint'e göre doğru parametre adını kullan
              if (endpoint === "SendPhotoAttachment") {
                formData.append("photo", file);
              } else if (endpoint === "SendVideoAttachment") {
                formData.append("video", file);
              } else if (endpoint === "SendAudioAttachment") {
                formData.append("audio", file);
              } else {
                formData.append("file", file);
              }

              const senderProfileId = senderProfiles[matchModeType];

              if (!senderProfileId) {
                console.error(
                  "Sender profile ID not found for matchModeType:",
                  matchModeType
                );
                alert(
                  "Profile not found for this match type. Please try again later."
                );
                e.target.value = "";
                return;
              }

              if (!receiverProfileId) {
                console.error("Receiver profile ID is missing");
                alert("Please select a chat first.");
                e.target.value = "";
                return;
              }

              // Show uploading indicator
              const chatMessages = document.getElementById("chatMessages");
              const uploadingMsg = document.createElement("div");
              uploadingMsg.className = `message sent`;
              uploadingMsg.innerHTML = `<span>Uploading ${fileType}...</span>`;
              chatMessages.appendChild(uploadingMsg);
              chatMessages.scrollTop = chatMessages.scrollHeight;

              // Choose API endpoint
              console.log("Sending attachment:", {
                endpoint,
                formData,
                senderProfileId,
                receiverProfileId,
              });

              // Upload to API
              const response = await axios.post(
                `${BASE_URL}/api/Chat/${endpoint}`,
                formData,
                {
                  headers: {
                    Authorization: `Bearer ${accessToken}`,
                    "Content-Type": "multipart/form-data",
                  },
                  params: {
                    senderProfileId,
                    receiverProfileId,
                  },
                }
              );

              // Dosya yükleme işleminin "başarılı yanıt" kısmını değiştirin
              console.log("Upload successful:", response.data);

              // // Remove uploading message
              // chatMessages.removeChild(uploadingMsg);

              // API'den dönen JSON formatına göre URL'yi alın
              let fileUrl;
              if (response.data && response.data.response) {
                // API'nin döndüğü JSON formatı: { response: { url: "..." } }
                fileUrl = response.data.response.url;

                if (!fileUrl) {
                  console.warn(
                    "URL not found in expected format, checking alternative formats"
                  );
                  // Alternatif formatları da kontrol et (geriye dönük uyumluluk)
                  fileUrl =
                    response.data.response.URL ||
                    (typeof response.data.response === "string"
                      ? response.data.response
                      : null);
                }
              } else {
                console.error("Unexpected response format:", response.data);
                throw new Error(
                  "Server response did not contain a valid file URL"
                );
              }

              console.log("Using file URL:", fileUrl);

              // Display the file message
              const messageType =
                fileType === "image"
                  ? 2
                  : fileType === "video"
                  ? 3
                  : fileType === "audio"
                  ? 4
                  : 5;

              // // Ekrana mesajı göster
              // const messageElement = displayMessage({
              //   Id: id,
              //   Content: fileUrl,
              //   Type: messageType,
              //   isSent: true,
              // });

              // Clear input
              e.target.value = "";
            } catch (error) {
              console.error(`Failed to upload ${fileType}:`, error);
              console.log(
                "Error details:",
                error.response
                  ? {
                      status: error.response.status,
                      statusText: error.response.statusText,
                      data: error.response.data,
                    }
                  : error.message
              );

              // Remove uploading message
              const chatMessages = document.getElementById("chatMessages");
              const uploadingMsg = chatMessages.querySelector(
                ".message.sent:last-child"
              );
              if (
                uploadingMsg &&
                uploadingMsg.textContent.includes("Uploading")
              ) {
                chatMessages.removeChild(uploadingMsg);
              }

              alert(
                `Failed to upload ${fileType}. ${
                  error.response?.data?.message || error.message
                }`
              );
              e.target.value = "";
            }
          });
        });

        console.log("Attachment system initialized successfully!");
      }

      // -------------------- EVENT LISTENERS --------------------

      document
        .getElementById("sendButton")
        .addEventListener("click", async () => {
          const messageInput = document.getElementById("messageInput");
          const message = messageInput.value.trim();
          if (!message) return;

          try {
            const senderProfileId = senderProfiles[matchModeType];
            if (!senderProfileId) {
              console.error(
                "Sender profile ID not found for matchModeType:",
                matchModeType
              );
              return;
            }

            // Kendim mesaj gönderdiğimde çağrılan yer
            displayMessage({ Content: message, isSent: true });
            await connection.invoke(
              "SendMessage",
              senderProfileId,
              receiverProfileId,
              message
            );
            messageInput.value = "";

            // Son mesajı chat listesinde güncelle (ben gönderdim, true)
            updateLastMessageInSidebar(
              receiverProfileId,
              message,
              1,
              false,
              true,
              true
            );
          } catch (error) {
            console.error("Failed to send message:", error);
          }
        });

      document
        .getElementById("messageInput")
        .addEventListener("input", async () => {
          try {
            if (receiverProfileId) {
              await connection.invoke(
                "StartTyping",
                senderProfiles[matchModeType],
                receiverProfileId
              );
              if (typingTimeout) {
                clearTimeout(typingTimeout);
              }
            }
          } catch (error) {
            console.error("Failed to notify typing start:", error);
          }
        });

      document.getElementById("messageInput").addEventListener("blur", () => {
        if (receiverProfileId) {
          typingTimeout = setTimeout(async () => {
            try {
              await connection.invoke(
                "StopTyping",
                senderProfiles[matchModeType],
                receiverProfileId
              );
            } catch (error) {
              console.error("Failed to notify typing stop:", error);
            }
          }, 1000);
        }
      });

      // Handle connection state changes
      connection.onclose(async () => {
        console.log("SignalR connection closed");
        await startConnection();
      });

      connection.onreconnecting((error) => {
        console.log("SignalR reconnecting:", error);
      });

      connection.onreconnected((connectionId) => {
        console.log("SignalR reconnected with ID:", connectionId);
      });

      // Close connection when page unloads
      window.addEventListener("beforeunload", function (e) {
        if (
          connection &&
          connection.state === signalR.HubConnectionState.Connected
        ) {
          connection
            .stop()
            .catch((err) => console.error("Error stopping connection:", err));
        }
      });

      // Initialize app
      window.addEventListener("DOMContentLoaded", async () => {
        try {
          await getLoggedInUserProfileState();
          console.log("Sender profiles loaded:", senderProfiles);
          await fetchChats();
          await startConnection();
          initializeAttachmentSystem();
          initializeAIHelpSystem(); // AI Yardım Sistemini başlat
        } catch (error) {
          console.error("Error initializing chat:", error);
        }
      });

      // Son mesajı chat listesinde güncelle
      function updateLastMessageInSidebar(
        profileId,
        message,
        type = 1,
        isDeleted = false,
        isFromSelf = true,
        isRead = false
      ) {
        const chatItem = document.querySelector(
          `.chat-item[data-profile-id="${profileId}"]`
        );
        if (!chatItem) return;

        const lastMessageElement = chatItem.querySelector(".last-message");
        if (!lastMessageElement) return;

        let messageText = "";
        // Mesaj öneki belirleme
        const messagePrefix = isFromSelf ? "You: " : "";

        // Mesaj içeriğini türüne göre belirle
        if (isDeleted) {
          messageText = "This message was deleted";
        } else if (type === 1) {
          // Text message
          messageText =
            message.length > 20 ? message.substring(0, 17) + "..." : message;
        } else if (type === 2) {
          messageText = "📷 Image";
        } else if (type === 3) {
          messageText = "🎬 Video";
        } else if (type === 4) {
          messageText = "🎵 Audio";
        } else if (type === 5) {
          messageText = "📎 File";
        }

        const timeString = formatMessageTime(new Date());

        // Okunmamış mesajlar için stil
        const isUnread = !isRead && !isFromSelf;
        const messageStyle = isUnread
          ? 'style="color: #007bff; font-weight: bold;"'
          : "";

        lastMessageElement.innerHTML = `
            <div class="last-message-content">
                <span class="text" ${messageStyle}>${messagePrefix}${messageText}</span>
                <span class="time">${timeString}</span>
            </div>
        `;
      }

      // Mesajları okundu olarak işaretleme fonksiyonu
      function markMessagesAsRead() {
        if (!receiverProfileId || !matchId) return;

        try {
          console.log("Marking messages as read for match:", matchId);

          // Çağrı öncesi okunmamış mesajları UI'da da işaretle
          const unreadMessages = document.querySelectorAll(
            ".message.received:not(.read)"
          );
          unreadMessages.forEach((msg) => {
            msg.classList.add("read");
            console.log("Marked message as read in UI:", msg.dataset.messageId);
          });

          connection
            .invoke(
              "MarkMessagesAsRead",
              senderProfiles[matchModeType],
              receiverProfileId,
              matchId
            )
            .then(() => {
              console.log("Successfully marked messages as read");
            })
            .catch((err) =>
              console.error("Error marking messages as read:", err)
            );
        } catch (error) {
          console.error("Failed to mark messages as read:", error);
        }
      }

      // Chat penceresini kaydırdığında mesajları okundu olarak işaretle
      document.getElementById("chatMessages").addEventListener(
        "scroll",
        debounce(() => {
          markMessagesAsRead();
        }, 500)
      );

      // Debounce fonksiyonu
      function debounce(func, wait) {
        let timeout;
        return function (...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(this, args), wait);
        };
      }

      // Sayfa görünür hale geldiğinde mesajları okundu olarak işaretle
      document.addEventListener("visibilitychange", () => {
        if (
          document.visibilityState === "visible" &&
          receiverProfileId &&
          matchId
        ) {
          markMessagesAsRead();
        }
      });
    </script>
  </body>
</html>
